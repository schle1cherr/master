worker_processes 1;

events {
    worker_connections 1024;
}

http {
    include       mime.types;
    default_type  application/octet-stream;

    sendfile        on;
    keepalive_timeout 65;

    # -------------------------------------
    # HTTP (Port 80) → Weiterleitung auf HTTPS
    # -------------------------------------
    server {
        listen 80;
        server_name eppstein.robinschleicher.de;

        # Umleitung auf HTTPS
        return 301 https://$host$request_uri;
    }

    # -------------------------------------
    # HTTPS Server (Port 443) mit Zertifikat
    # -------------------------------------
    server {
        listen 443 ssl;
        server_name eppstein.robinschleicher.de;

        # SSL-Zertifikate (Pfad ggf. anpassen!)
        ssl_certificate           C:/WebServer/certs/cert.pem;
        ssl_certificate_key       C:/WebServer/certs/privkey.pem;
        ssl_trusted_certificate   C:/WebServer/certs/chain.pem;

        ssl_protocols TLSv1.2 TLSv1.3;
        ssl_ciphers HIGH:!aNULL:!MD5;
        ssl_session_cache shared:SSL:1m;
        ssl_session_timeout 5m;
        ssl_prefer_server_ciphers on;

        # Root-Verzeichnis für statische Inhalte
        root   C:/WebServer/nginx/html;
        index  index.html index.htm;

        # ------------------------------
        # Standard-Route
        # ------------------------------
        location / {
            try_files $uri $uri/ =404;
        }

        # ------------------------------
        # Proxys zu lokalen Anwendungen
        # ------------------------------
        location /ask {
            proxy_pass         http://127.0.0.1:8000/ask;
            proxy_http_version 1.1;
            proxy_set_header   Upgrade $http_upgrade;
            proxy_set_header   Connection keep-alive;
            proxy_set_header   Host $host;
            proxy_cache_bypass $http_upgrade;
        }

        location /build {
            proxy_pass http://127.0.0.1:8000/build;
        }

        location /test-dokumente {
            proxy_pass http://127.0.0.1:8000/test-dokumente;
        }

        # ------------------------------
        # Let’s Encrypt HTTP Challenge (für ACME)
        # ------------------------------
        location ^~ /.well-known/acme-challenge/ {
            alias C:/WebServer/nginx/html/.well-known/acme-challenge/;
            default_type "text/plain";
            try_files $uri =404;
        }

        # ------------------------------
        # PKI-Validation (z. B. für ZeroSSL)
        # ------------------------------
        location ^~ /.well-known/pki-validation/ {
            alias C:/WebServer/nginx/html/.well-known/pki-validation/;
            default_type "text/plain";
            try_files $uri =404;
        }

        # ------------------------------
        # Fehlerseiten
        # ------------------------------
        error_page 500 502 503 504 /50x.html;
        location = /50x.html {
            root C:/WebServer/nginx/html;
        }
    }
}
